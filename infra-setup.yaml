# Service Account for Jenkins (Permissions)
apiVersion: v1
kind: ServiceAccount
metadata: { name: jenkins-admin, namespace: tools }
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata: { name: jenkins-admin-binding }
subjects: [{ kind: ServiceAccount, name: jenkins-admin, namespace: tools }]
roleRef: { kind: ClusterRole, name: cluster-admin, apiGroup: rbac.authorization.k8s.io }
---
# Jenkins Deployment
apiVersion: apps/v1
kind: Deployment
metadata: { name: jenkins, namespace: tools }
spec:
  replicas: 1
  selector: { matchLabels: { app: jenkins } }
  template:
    metadata: { labels: { app: jenkins } }
    spec:
      serviceAccountName: jenkins-admin
      nodeSelector: { workload: tools }
      containers:
      - name: jenkins
        image: jenkins/jenkins:lts
        ports: [{ containerPort: 8080 }]
        volumeMounts: [{ name: docker, mountPath: /var/run/docker.sock }]
      volumes: [{ name: docker, hostPath: { path: /var/run/docker.sock } }]
---
# Jenkins Service (Port 30000)
apiVersion: v1
kind: Service
metadata: { name: jenkins, namespace: tools }
spec:
  type: NodePort
  selector: { app: jenkins }
  ports: [{ port: 8080, nodePort: 30000 }]
---
# SonarQube Deployment
apiVersion: apps/v1
kind: Deployment
metadata: { name: sonarqube, namespace: tools }
spec:
  replicas: 1
  selector: { matchLabels: { app: sonarqube } }
  template:
    metadata: { labels: { app: sonarqube } }
    spec:
      nodeSelector: { workload: tools }
      containers:
      - name: sonarqube
        image: sonarqube:lts
        env: [{ name: SONAR_ES_BOOTSTRAP_CHECKS_DISABLE, value: "true" }]
        ports: [{ containerPort: 9000 }]
---
# SonarQube Service (Internal)
apiVersion: v1
kind: Service
metadata: { name: sonarqube, namespace: tools }
spec:
  selector: { app: sonarqube }
  ports: [{ port: 9000 }]
